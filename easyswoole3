FROM ubuntu:22.04

#version defined
#ENV PHP_VERSION php7.4

RUN ulimit -c 0;
RUN ulimit -n 1024000

# 设置策略
RUN touch /etc/apt/apt.conf.d/99verify-peer.conf \ && echo >>/etc/apt/apt.conf.d/99verify-peer.conf "Acquire { https::Verify-Peer false }"

# 设置镜像源
RUN sed -i 's#http://archive.ubuntu.com/#https://mirrors.tuna.tsinghua.edu.cn/ubuntu/#' /etc/apt/sources.list;

## 清理镜像
RUN apt-get clean
RUN apt-get autoclean
RUN apt-get update
RUN apt-get upgrade -y

RUN apt-get install -y wget
RUN apt-get install -y vim
RUN apt-get install -y inetutils-ping
RUN apt-get install -y telnet

RUN apt-get install -y memcached libmemcached-dev
RUN apt-get install -y redis-server

# 更改php源
RUN apt-get install -y software-properties-common
RUN LC_ALL=C.UTF-8 add-apt-repository -y ppa:ondrej/php

# 调试工具
RUN apt-get install -y gdb

## 设置时区
RUN export DEBIAN_FRONTEND=noninteractive \
    && apt-get install -y tzdata \
    && ln -fs /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \
    && dpkg-reconfigure --frontend noninteractive tzdata

## install libs
RUN apt-get install -y          \
    curl                        \
    zip                         \
    unzip                       \
    #openssl-devel \
    libcurl4-openssl-dev       \
    libssl-dev                 \
    #gcc-c++ \
    gcc         \
    g++ \
    make \
    libtool \
    autoconf \
    automake \
    git \
    net-tools \
    #telnet-server \
    #pcre-devel \
    #pcre \
    #pcre-devel \
    #zlib \
    #zlib-devel\
    zlib1g-dev               \
    supervisor                 \
    psmisc

# zsh
RUN apt-get install -y zsh
RUN chsh -s /bin/zsh
RUN sh -c "$(curl -fsSL https://gitee.com/shmhlsy/oh-my-zsh-install.sh/raw/master/install.sh)"
#zsh-autosuggestions 命令行命令键入时的历史命令建议
RUN git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
#zsh-syntax-highlighting 命令行语法高亮插件
RUN git clone https://gitee.com/Annihilater/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting

# 安装宝塔插件
RUN wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && echo y | bash install.sh 15361c9e

## 安装php
RUN apt-get install -y    \
   php7.4                \
   php7.4-curl           \
   php7.4-fpm            \
   php7.4-gd             \
   php7.4-intl           \
   php7.4-imap           \
   php7.4-xml            \
   php7.4-xmlrpc         \
   php7.4-zip               \
   php7.4-sqlite3        \
   php7.4-mbstring       \
   php7.4-json           \
   php7.4-mysqlnd        \
   php7.4-cli            \
   php7.4-dev            \
   php7.4-redis          \
   php7.4-mysqli         \
   php7.4-oauth          \
   php7.4-memcache       \
   php7.4-memcached      \
   php7.4-mcrypt         \
   php7.4-lua            \
   php7.4-json           \
   php7.4-bcmath         \
   php7.4-mongodb        \
   php7.4-imagick        \
   php7.4-common

# composer
RUN wget -c https://mirrors.aliyun.com/composer/composer.phar \
    && chmod 755 composer.phar \
    && mv composer.phar /usr/bin/composer

## use aliyun composer
RUN composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/

# fswatch ext
RUN wget https://github.com/emcrisostomo/fswatch/releases/download/1.15.0/fswatch-1.15.0.tar.gz -O fswatch.tar.gz \
    && mkdir -p fswatch \
    && tar zxvf fswatch.tar.gz -C fswatch --strip-components=1 \
    && rm -rf fswatch.tar.gz \
    && ( \
    cd fswatch \
    && ./configure  \
    && make \
    && make install  \
    ) \
    && rm -rf fswatch;

# inotify
RUN wget http://pecl.php.net/get/inotify-2.0.0.tgz -O inotify.tar.gz \
    && mkdir -p inotify \
    && tar zxvf inotify.tar.gz -C inotify --strip-components=1 \
    && rm inotify.tar.gz \
    && ( \
    cd inotify \
    && phpize \
    && ./configure  \
    && make \
    && make install \
    ) \
    && echo 'extension=inotify.so' > /etc/php/7.4/cli/conf.d/20-inotify.ini \
    && echo 'extension=inotify.so' > /etc/php/7.4/mods-available/20-inotify.ini \
    && echo 'extension=inotify.so' > /etc/php/7.4/fpm/conf.d/20-inotify.ini \
    && cd .. \
    && rm -r inotify

# xlswriter
RUN wget http://pecl.php.net/get/xlswriter -O xlswriter.tar.gz \
    && mkdir -p xlswriter \
    && tar zxvf xlswriter.tar.gz -C xlswriter --strip-components=1 \
    && rm -rf xlswriter.tar.gz \
    && ( \
    cd xlswriter \
    && phpize \
    && ./configure --enable-reader \
    && make \
    && make install \
    ) \
    && echo 'extension=xlswriter.so' > /etc/php/7.4/cli/conf.d/20-xlswriter.ini \
    && echo 'extension=xlswriter.so' > /etc/php/7.4/mods-available/20-xlswriter.ini \
    && echo 'extension=xlswriter.so' > /etc/php/7.4/fpm/conf.d/20-xlswriter.ini \
    && cd .. \
    && rm -rf xlswriter;

# blake2
RUN cd /tmp \
    && rm -rf blake2 \
    && git clone https://github.com/strawbrary/php-blake2 ./blake2 \
    && ( \
    cd blake2 \
    && phpize \
    && ./configure --enable-blake2 \
    && make \
    && make install \
    ) \
    && echo 'extension=blake2.so' > /etc/php/7.4/cli/conf.d/20-blake2.ini \
    && echo 'extension=blake2.so' > /etc/php/7.4/mods-available/20-blake2.ini \
    && echo 'extension=blake2.so' > /etc/php/7.4/fpm/conf.d/20-blake2.ini \
    && cd .. \
    && rm -rf blake2;

# libzip
RUN wget http://nih.at/libzip/libzip-1.2.0.tar.gz -O libzip.tar.gz \
    && mkdir -p libzip \
    && tar -zxvf libzip.tar.gz -C libzip --strip-components=1 \
    && rm -rf libzip.tar.gz \
    && ( \
    cd libzip \
    && ./configure  \
    && make \
    && make install \
    ) \
    && cd .. \
    && rm -rf libzip;

# zip
RUN wget http://pecl.php.net/get/zip-1.19.2.tgz -O zip.tar.gz \
    && mkdir -p zip \
    && cp /usr/local/lib/libzip/include/zipconf.h /usr/local/include/zipconf.h \
    && tar zxvf zip.tar.gz -C zip --strip-components=1 \
    && rm -rf zip.tar.gz \
    && ( \
    cd zip \
    && phpize \
    && ./configure  \
    && make \
    && make install \
    ) \
    && echo 'extension=zip.so' > /etc/php/7.4/cli/conf.d/20-zip.ini \
    && echo 'extension=zip.so' > /etc/php/7.4/mods-available/20-zip.ini \
    && echo 'extension=zip.so' > /etc/php/7.4/fpm/conf.d/20-zip.ini \
    && cd .. \
    && rm -rf zip;

# 安装扩展
RUN pecl install grpc http://pecl.php.net/package/gRPC/1.48.1
RUN echo 'extension=grpc.so' > /etc/php/7.4/cli/conf.d/grpc.ini

RUN pecl install protobuf http://pecl.php.net/package/protobuf/3.21.5
RUN echo 'extension=protobuf.so' > /etc/php/7.4/cli/conf.d/protobuf.ini

# swoole
RUN pecl install --configureoptions 'enable-sockets="no" enable-openssl="yes" enable-http2="yes" enable-mysqlnd="no" enable-swoole-json="no" enable-swoole-curl="yes" enable-cares="yes"' swoole http://pecl.php.net/get/swoole-4.4.26.tgz
RUN echo 'extension=swoole.so' > /etc/php/7.4/cli/conf.d/swoole.ini

#指定容器里面的路径
WORKDIR /mnt/server/php
CMD ["tail", "-f", "/dev/null"]